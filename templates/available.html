<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Available Books</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.3.4/css/dataTables.dataTables.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.5/css/buttons.dataTables.css">
    <style>
      /* small spacing fix for modal content */
      .book-abstract { white-space: pre-wrap; }
    </style>
</head>
<body>
<div class="container-fluid my-3">
  <div class="card shadow-lg">
    <div class="card-header bg-secondary text-white">
      <h3 class="mb-0">ðŸ“š Available Books</h3>
    </div>

    <div class="card-body">
      <table id="example" class="display nowrap table table-striped" style="width:100%">
        <thead>
            <tr>
                 <th>Scanner ID</th>
                 <th>Title</th>
                 <th>Author</th>
                 <th>Year</th>
                 <th>Publisher</th>
                 <th>Department</th>
                 <th>Abstract</th>
                 <th>Available</th>  <!-- NEW column -->
            </tr>
        </thead>
        <tbody>
          {% for book in books %}
            <tr>
                <td>{{ book.scanner }}</td>
                <td>{{ book.title }}</td>
                <td>{{ book.author }}</td>
                <td>{{ book.year }}</td>
                <td>{{ book.publisher }}</td>
                <td>{{ book.department }}</td>
                <td>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-primary view-abstract-btn"
                    data-url="{% url 'book_abstract' book.pk %}"
                  >
                    Abstract
                  </button>
                </td>
                  <td>
                 {% if book.is_currently_available %}
                    <span class="badge bg-success">Yes</span>
                 {% else %}
                     <span class="badge bg-danger">No</span>
                 {% endif %}
                </td>
            </tr>
          {% empty %}
            <tr>
                <td colspan="7" class="text-center text-muted">No books available.</td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <th>Scanner ID</th>
                <th>Title</th>
                <th>Author</th>
                <th>Year</th>
                <th>Edition</th>
                <th>Department</th>
                <th>Abstract</th>
                <th>Available</th> 
            </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<!-- Abstract Modal (Bootstrap 5) -->
<div class="modal fade" id="abstractModal" tabindex="-1" aria-labelledby="abstractModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="abstractModalLabel">Book Abstract</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="abstractModalBody">
        <div class="text-center py-4">Loadingâ€¦</div>
      </div>
    </div>
  </div>
</div>

<!-- JS libs -->
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.datatables.net/2.3.4/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.5/js/dataTables.buttons.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.5/js/buttons.dataTables.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.5/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.5/js/buttons.print.min.js"></script>

<script>
  // Initialize DataTable (same as your code)
  new DataTable('#example', {
    layout: {
      topStart: {
        buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
      }
    }
  });

  // Modal + AJAX logic
  document.addEventListener('DOMContentLoaded', function() {
    const modalEl = document.getElementById('abstractModal');
    const modalBody = document.getElementById('abstractModalBody');
    const bsModal = new bootstrap.Modal(modalEl);

    document.querySelectorAll('.view-abstract-btn').forEach(btn => {
      btn.addEventListener('click', async function() {
        const url = this.dataset.url;
        modalBody.innerHTML = '<div class="text-center py-4">Loadingâ€¦</div>';
        bsModal.show();

        try {
          const res = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' }});
          if (!res.ok) throw new Error('Network response not ok');
          const data = await res.json();
          modalBody.innerHTML = data.html || '<p class="text-muted">No content.</p>';
        } catch (err) {
          modalBody.innerHTML = `<div class="alert alert-danger">Failed to load abstract: ${err.message}</div>`;
        }
      });
    });
  });
</script>

</body>
</html>